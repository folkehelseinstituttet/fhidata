<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Skeletons • fhidata</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Skeletons">
<meta property="og:description" content="fhidata">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">fhidata</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2021.6.21</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/fhidata.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Skeletons.html">Skeletons</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/folkehelseinstituttet/fhidata/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="Skeletons_files/header-attrs-2.8/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Skeletons</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/folkehelseinstituttet/fhidata/blob/master/vignettes/Skeletons.Rmd"><code>vignettes/Skeletons.Rmd</code></a></small>
      <div class="hidden name"><code>Skeletons.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/folkehelseinstituttet/fhidata">fhidata</a></span><span class="op">)</span>
<span class="co">#&gt; fhidata 2021.6.21 https://folkehelseinstituttet.github.io/fhidata/</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span></code></pre></div>
<div id="checklists" class="section level2">
<h2 class="hasAnchor">
<a href="#checklists" class="anchor"></a>Checklists</h2>
<p>Note that <code>fhidata</code> has RStudio addins that help you create skeletons!</p>
<div id="secure-zone" class="section level3">
<h3 class="hasAnchor">
<a href="#secure-zone" class="anchor"></a>Secure zone</h3>
<ol style="list-style-type: decimal">
<li>Aggregate the data to multiple geographical granularities</li>
</ol>
</div>
</div>
<div id="ordinary-zone" class="section level2">
<h2 class="hasAnchor">
<a href="#ordinary-zone" class="anchor"></a>Ordinary zone</h2>
<ol style="list-style-type: decimal">
<li>Create a variable (possibly a list) to hold the data</li>
<li>Clean the data</li>
<li>Replace NAs as appropriate for MSIS location numbers</li>
<li>Convert MSIS location numbers to location_code’s using <code><a href="../reference/norway_locations_msis_to_fhidata.html">fhidata::norway_locations_msis_to_fhidata</a></code> (you may also do redistricting now)</li>
<li>Re-aggregate your data to different geographical levels to ensure that duplicates have now been removed</li>
<li>Pull out important dates</li>
<li>Create <code>multiskeleton</code>
</li>
<li>Merge in the information you have at different geographical granularities</li>
<li>Aggregate up to higher geographical granularities</li>
<li>(If desirable) aggregate up to higher time granularities</li>
</ol>
</div>
<div id="simple-example-only-county-data-is-given" class="section level2">
<h2 class="hasAnchor">
<a href="#simple-example-only-county-data-is-given" class="anchor"></a>Simple example: Only county data is given</h2>
<p>This is a simple example to introduce you to the concepts of skeletons</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># setting up the data</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span>
  date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2020-01-01"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2020-01-20"</span><span class="op">)</span>, by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, 
  location_msis_county <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">3</span>, <span class="fl">50</span>, <span class="fl">52</span>, <span class="cn">NA</span><span class="op">)</span>,
  stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span>
<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setDT.html">setDT</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>
<span class="va">data</span><span class="op">[</span>, <span class="va">cases_n</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">rpois</a></span><span class="op">(</span><span class="va">.N</span>, <span class="fl">5</span><span class="op">)</span><span class="op">]</span>
<span class="va">data</span><span class="op">[</span><span class="op">]</span>
<span class="co">#&gt;            date location_msis_county cases_n</span>
<span class="co">#&gt;   1: 2020-01-01                    3       5</span>
<span class="co">#&gt;   2: 2020-01-02                    3       3</span>
<span class="co">#&gt;   3: 2020-01-03                    3       5</span>
<span class="co">#&gt;   4: 2020-01-04                    3       8</span>
<span class="co">#&gt;   5: 2020-01-05                    3       3</span>
<span class="co">#&gt;   6: 2020-01-06                    3       2</span>
<span class="co">#&gt;   7: 2020-01-07                    3       3</span>
<span class="co">#&gt;   8: 2020-01-08                    3       5</span>
<span class="co">#&gt;   9: 2020-01-09                    3       4</span>
<span class="co">#&gt;  10: 2020-01-10                    3       6</span>
<span class="co">#&gt;  11: 2020-01-11                    3       5</span>
<span class="co">#&gt;  12: 2020-01-12                    3       3</span>
<span class="co">#&gt;  13: 2020-01-13                    3       6</span>
<span class="co">#&gt;  14: 2020-01-14                    3       7</span>
<span class="co">#&gt;  15: 2020-01-15                    3       3</span>
<span class="co">#&gt;  16: 2020-01-16                    3       6</span>
<span class="co">#&gt;  17: 2020-01-17                    3       5</span>
<span class="co">#&gt;  18: 2020-01-18                    3       7</span>
<span class="co">#&gt;  19: 2020-01-19                    3       4</span>
<span class="co">#&gt;  20: 2020-01-20                    3       9</span>
<span class="co">#&gt;  21: 2020-01-01                    3       2</span>
<span class="co">#&gt;  22: 2020-01-02                    3       6</span>
<span class="co">#&gt;  23: 2020-01-03                    3       3</span>
<span class="co">#&gt;  24: 2020-01-04                    3       6</span>
<span class="co">#&gt;  25: 2020-01-05                    3       5</span>
<span class="co">#&gt;  26: 2020-01-06                    3       9</span>
<span class="co">#&gt;  27: 2020-01-07                    3       3</span>
<span class="co">#&gt;  28: 2020-01-08                    3       2</span>
<span class="co">#&gt;  29: 2020-01-09                    3      11</span>
<span class="co">#&gt;  30: 2020-01-10                    3       3</span>
<span class="co">#&gt;  31: 2020-01-11                    3       2</span>
<span class="co">#&gt;  32: 2020-01-12                    3       1</span>
<span class="co">#&gt;  33: 2020-01-13                    3       3</span>
<span class="co">#&gt;  34: 2020-01-14                    3       3</span>
<span class="co">#&gt;  35: 2020-01-15                    3       8</span>
<span class="co">#&gt;  36: 2020-01-16                    3       4</span>
<span class="co">#&gt;  37: 2020-01-17                    3       4</span>
<span class="co">#&gt;  38: 2020-01-18                    3       7</span>
<span class="co">#&gt;  39: 2020-01-19                    3       2</span>
<span class="co">#&gt;  40: 2020-01-20                    3       2</span>
<span class="co">#&gt;  41: 2020-01-01                   50       3</span>
<span class="co">#&gt;  42: 2020-01-02                   50       6</span>
<span class="co">#&gt;  43: 2020-01-03                   50       5</span>
<span class="co">#&gt;  44: 2020-01-04                   50      10</span>
<span class="co">#&gt;  45: 2020-01-05                   50       5</span>
<span class="co">#&gt;  46: 2020-01-06                   50       4</span>
<span class="co">#&gt;  47: 2020-01-07                   50       5</span>
<span class="co">#&gt;  48: 2020-01-08                   50       9</span>
<span class="co">#&gt;  49: 2020-01-09                   50       2</span>
<span class="co">#&gt;  50: 2020-01-10                   50       4</span>
<span class="co">#&gt;  51: 2020-01-11                   50       1</span>
<span class="co">#&gt;  52: 2020-01-12                   50      10</span>
<span class="co">#&gt;  53: 2020-01-13                   50       1</span>
<span class="co">#&gt;  54: 2020-01-14                   50       6</span>
<span class="co">#&gt;  55: 2020-01-15                   50       5</span>
<span class="co">#&gt;  56: 2020-01-16                   50       3</span>
<span class="co">#&gt;  57: 2020-01-17                   50       6</span>
<span class="co">#&gt;  58: 2020-01-18                   50       5</span>
<span class="co">#&gt;  59: 2020-01-19                   50       6</span>
<span class="co">#&gt;  60: 2020-01-20                   50       9</span>
<span class="co">#&gt;  61: 2020-01-01                   52       6</span>
<span class="co">#&gt;  62: 2020-01-02                   52       2</span>
<span class="co">#&gt;  63: 2020-01-03                   52       9</span>
<span class="co">#&gt;  64: 2020-01-04                   52       7</span>
<span class="co">#&gt;  65: 2020-01-05                   52       2</span>
<span class="co">#&gt;  66: 2020-01-06                   52       3</span>
<span class="co">#&gt;  67: 2020-01-07                   52       2</span>
<span class="co">#&gt;  68: 2020-01-08                   52       9</span>
<span class="co">#&gt;  69: 2020-01-09                   52       7</span>
<span class="co">#&gt;  70: 2020-01-10                   52       6</span>
<span class="co">#&gt;  71: 2020-01-11                   52       3</span>
<span class="co">#&gt;  72: 2020-01-12                   52       1</span>
<span class="co">#&gt;  73: 2020-01-13                   52       3</span>
<span class="co">#&gt;  74: 2020-01-14                   52       6</span>
<span class="co">#&gt;  75: 2020-01-15                   52      10</span>
<span class="co">#&gt;  76: 2020-01-16                   52       3</span>
<span class="co">#&gt;  77: 2020-01-17                   52       8</span>
<span class="co">#&gt;  78: 2020-01-18                   52      10</span>
<span class="co">#&gt;  79: 2020-01-19                   52       6</span>
<span class="co">#&gt;  80: 2020-01-20                   52       9</span>
<span class="co">#&gt;  81: 2020-01-01                   NA      10</span>
<span class="co">#&gt;  82: 2020-01-02                   NA       5</span>
<span class="co">#&gt;  83: 2020-01-03                   NA       8</span>
<span class="co">#&gt;  84: 2020-01-04                   NA       2</span>
<span class="co">#&gt;  85: 2020-01-05                   NA       4</span>
<span class="co">#&gt;  86: 2020-01-06                   NA       4</span>
<span class="co">#&gt;  87: 2020-01-07                   NA      10</span>
<span class="co">#&gt;  88: 2020-01-08                   NA       3</span>
<span class="co">#&gt;  89: 2020-01-09                   NA       6</span>
<span class="co">#&gt;  90: 2020-01-10                   NA       2</span>
<span class="co">#&gt;  91: 2020-01-11                   NA       5</span>
<span class="co">#&gt;  92: 2020-01-12                   NA       7</span>
<span class="co">#&gt;  93: 2020-01-13                   NA       5</span>
<span class="co">#&gt;  94: 2020-01-14                   NA       6</span>
<span class="co">#&gt;  95: 2020-01-15                   NA       4</span>
<span class="co">#&gt;  96: 2020-01-16                   NA       6</span>
<span class="co">#&gt;  97: 2020-01-17                   NA       6</span>
<span class="co">#&gt;  98: 2020-01-18                   NA       0</span>
<span class="co">#&gt;  99: 2020-01-19                   NA       3</span>
<span class="co">#&gt; 100: 2020-01-20                   NA       8</span>
<span class="co">#&gt;            date location_msis_county cases_n</span>

<span class="co"># 1. Create a variable (possibly a list) to hold the data</span>
<span class="co"># 2. Clean the data</span>
<span class="co"># cleaning the data</span>
<span class="va">d_agg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/copy.html">copy</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>
<span class="co"># 3. Replace NAs as appropriate for MSIS location numbers</span>
<span class="va">d_agg</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">location_msis_county</span><span class="op">)</span>, <span class="va">location_msis_county</span> <span class="op">:=</span> <span class="fl">99</span><span class="op">]</span>
<span class="co"># 4. Convert MSIS location numbers to location_code's using `fhidata::norway_locations_msis_to_fhidata`</span>
<span class="co"># you may also do redistricting (kommunesammenslaaing) at this point (fhidata::norway_locations_redistricting())</span>
<span class="va">d_agg</span><span class="op">[</span>, <span class="va">location_code</span> <span class="op">:=</span> <span class="fu">fhidata</span><span class="fu">::</span><span class="fu"><a href="../reference/norway_locations_msis_to_fhidata.html">norway_locations_msis_to_fhidata</a></span><span class="op">(</span><span class="va">location_msis_county</span><span class="op">)</span><span class="op">]</span>

<span class="co"># 5. Re-aggregate your data to different geographical levels to ensure that duplicates have now been removed</span>
<span class="va">d_agg</span> <span class="op">&lt;-</span> <span class="va">d_agg</span><span class="op">[</span>
  ,
  <span class="fu">.</span><span class="op">(</span>
    cases_n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">cases_n</span><span class="op">)</span>
  <span class="op">)</span>,
  keyby <span class="op">=</span> <span class="fu">.</span><span class="op">(</span>
    <span class="va">date</span>,
    <span class="va">location_code</span>
  <span class="op">)</span>
<span class="op">]</span>

<span class="co">#6. Pull out important dates</span>
<span class="va">date_min</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">d_agg</span><span class="op">$</span><span class="va">date</span><span class="op">)</span>
<span class="va">date_max</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">d_agg</span><span class="op">$</span><span class="va">date</span><span class="op">)</span>

<span class="co"># 7. Create `multiskeleton`</span>
<span class="co"># granularity_geo should have the following groups:</span>
<span class="co"># - nodata (when no data is available, and there is no 'finer' data available to aggregate up)</span>
<span class="co"># - all levels of granularity_geo where you have data available</span>
<span class="co"># If you do not have data for a specific granularity_geo, but there is 'finer' data available</span>
<span class="co"># then you should not include this granularity_geo in the multiskeleton, because you will create</span>
<span class="co"># it later when you aggregate up your data (nation)</span>
<span class="va">multiskeleton_day</span> <span class="op">&lt;-</span> <span class="fu">fhidata</span><span class="fu">::</span><span class="fu"><a href="../reference/make_skeleton.html">make_skeleton</a></span><span class="op">(</span>
  date_min <span class="op">=</span> <span class="va">date_min</span>,
  date_max <span class="op">=</span> <span class="va">date_max</span>,
  granularity_geo <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    <span class="st">"nodata"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
      <span class="st">"wardoslo"</span>,
      <span class="st">"extrawardoslo"</span>,
      <span class="st">"missingwardoslo"</span>,
      <span class="st">"wardbergen"</span>,
      <span class="st">"missingwardbergen"</span>,
      <span class="st">"wardstavanger"</span>,
      <span class="st">"missingwardstavanger"</span>,
      <span class="st">"baregion"</span>,
      <span class="st">"municip"</span>,
      <span class="st">"notmainlandmunicip"</span>,
      <span class="st">"missingmunicip"</span>
    <span class="op">)</span>,
    
    <span class="st">"county"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
      <span class="st">"county"</span>,
      <span class="st">"notmainlandcounty"</span>, 
      <span class="st">"missingcounty"</span>
    <span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span>

<span class="co"># 8. Merge in the information you have at different geographical granularities</span>
<span class="co"># county level</span>
<span class="va">multiskeleton_day</span><span class="op">$</span><span class="va">county</span><span class="op">[</span>
  <span class="va">d_agg</span>,
  on <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"location_code"</span>, <span class="st">"date"</span><span class="op">)</span>,
  <span class="va">cases_n</span> <span class="op">:=</span> <span class="va">cases_n</span>
<span class="op">]</span>
<span class="va">multiskeleton_day</span><span class="op">$</span><span class="va">county</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">cases_n</span><span class="op">)</span>, <span class="va">cases_n</span> <span class="op">:=</span> <span class="fl">0</span><span class="op">]</span>

<span class="co"># 9. Aggregate up to higher geographical granularities</span>
<span class="va">multiskeleton_day</span><span class="op">$</span><span class="va">nation</span> <span class="op">&lt;-</span> <span class="va">multiskeleton_day</span><span class="op">$</span><span class="va">county</span><span class="op">[</span>
  ,
  <span class="fu">.</span><span class="op">(</span>
    cases_n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">cases_n</span><span class="op">)</span>,
    granularity_geo <span class="op">=</span> <span class="st">"nation"</span>,
    location_code <span class="op">=</span> <span class="st">"norge"</span>
  <span class="op">)</span>,
  keyby<span class="op">=</span><span class="fu">.</span><span class="op">(</span>
    <span class="va">granularity_time</span>, <span class="va">date</span>
  <span class="op">)</span>
<span class="op">]</span>

<span class="co"># 10. (If desirable) aggregate up to higher time granularities</span>
<span class="va">skeleton_day</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbindlist</a></span><span class="op">(</span><span class="va">multiskeleton_day</span>, fill <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
</div>
<div id="realistic-example-person-level-data-is-given-multiple-levels-of-data" class="section level2">
<h2 class="hasAnchor">
<a href="#realistic-example-person-level-data-is-given-multiple-levels-of-data" class="anchor"></a>Realistic example: Person-level data is given, multiple levels of data</h2>
<p>This is a more realistic example, where person-level data is given at multiple levels (nation, county, notmainlandcounty, missingcounty, municip, notmainlandmunicip, missingmunicip) and they must be aggregated inside the secure zone and then distributed further for processing and the creation of a skeleton.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># ---------------</span>
<span class="co"># setting up the data that would be seen from inside the "secure zone"</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span>
  date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2020-01-01"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2020-01-20"</span><span class="op">)</span>, by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, 
  location_msis_municip <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">301</span>, <span class="fl">1106</span>, <span class="fl">5001</span>, <span class="fl">5001</span>, <span class="fl">2200</span>, <span class="cn">NA</span>, <span class="cn">NA</span><span class="op">)</span>,
  variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>, <span class="co"># to get some extra rows in the data</span>
  stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span>
<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setDT.html">setDT</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>
<span class="va">data</span><span class="op">[</span>, <span class="va">location_msis_county</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="va">location_msis_municip</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span><span class="op">]</span>
<span class="va">data</span><span class="op">[</span> <span class="va">variable</span> <span class="op">%in%</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">location_msis_municip</span><span class="op">)</span>, <span class="va">location_msis_county</span> <span class="op">:=</span> <span class="fl">3</span><span class="op">]</span>
<span class="va">data</span><span class="op">[</span>, <span class="va">variable</span> <span class="op">:=</span> <span class="cn">NULL</span><span class="op">]</span>

<span class="va">data</span><span class="op">[</span><span class="op">]</span>
<span class="co">#&gt;            date location_msis_municip location_msis_county</span>
<span class="co">#&gt;   1: 2020-01-01                   301                    3</span>
<span class="co">#&gt;   2: 2020-01-02                   301                    3</span>
<span class="co">#&gt;   3: 2020-01-03                   301                    3</span>
<span class="co">#&gt;   4: 2020-01-04                   301                    3</span>
<span class="co">#&gt;   5: 2020-01-05                   301                    3</span>
<span class="co">#&gt;  ---                                                      </span>
<span class="co">#&gt; 696: 2020-01-16                    NA                   NA</span>
<span class="co">#&gt; 697: 2020-01-17                    NA                   NA</span>
<span class="co">#&gt; 698: 2020-01-18                    NA                   NA</span>
<span class="co">#&gt; 699: 2020-01-19                    NA                   NA</span>
<span class="co">#&gt; 700: 2020-01-20                    NA                   NA</span>

<span class="co"># ---------------</span>
<span class="co"># this code occurs inside the secure zone</span>
<span class="co"># we need to aggregate it down to make it less sensitive</span>
<span class="co"># and then distribute it as multiple data sets</span>
<span class="va">d_person</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/copy.html">copy</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>

<span class="va">d_agg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># this includes granularity_geo = municip, notmainlandmunicip, missingmunicip</span>
<span class="va">d_agg</span><span class="op">$</span><span class="va">day_municip</span> <span class="op">&lt;-</span> <span class="va">d_person</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span>
  cases_n <span class="op">=</span> <span class="va">.N</span>
<span class="op">)</span>, keyby<span class="op">=</span><span class="fu">.</span><span class="op">(</span>
  <span class="va">location_msis_municip</span>,
  <span class="va">date</span>
<span class="op">)</span><span class="op">]</span>

<span class="co"># this includes granularity_geo = county, notmainlandcounty, missingcounty</span>
<span class="va">d_agg</span><span class="op">$</span><span class="va">day_county</span> <span class="op">&lt;-</span> <span class="va">d_person</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span>
  cases_n <span class="op">=</span> <span class="va">.N</span>
<span class="op">)</span>, keyby<span class="op">=</span><span class="fu">.</span><span class="op">(</span>
  <span class="va">location_msis_county</span>,
  <span class="va">date</span>
<span class="op">)</span><span class="op">]</span>

<span class="co"># this includes granularity_geo = nation</span>
<span class="va">d_agg</span><span class="op">$</span><span class="va">day_nation</span> <span class="op">&lt;-</span> <span class="va">d_person</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span>
  cases_n <span class="op">=</span> <span class="va">.N</span>,
  location_msis_nation <span class="op">=</span> <span class="fl">0</span>
<span class="op">)</span>, keyby<span class="op">=</span><span class="fu">.</span><span class="op">(</span>
  <span class="va">date</span>
<span class="op">)</span><span class="op">]</span>

<span class="va">d_agg</span><span class="op">[</span><span class="op">]</span>
<span class="co">#&gt; $day_municip</span>
<span class="co">#&gt;      location_msis_municip       date cases_n</span>
<span class="co">#&gt;   1:                    NA 2020-01-01      10</span>
<span class="co">#&gt;   2:                    NA 2020-01-02      10</span>
<span class="co">#&gt;   3:                    NA 2020-01-03      10</span>
<span class="co">#&gt;   4:                    NA 2020-01-04      10</span>
<span class="co">#&gt;   5:                    NA 2020-01-05      10</span>
<span class="co">#&gt;   6:                    NA 2020-01-06      10</span>
<span class="co">#&gt;   7:                    NA 2020-01-07      10</span>
<span class="co">#&gt;   8:                    NA 2020-01-08      10</span>
<span class="co">#&gt;   9:                    NA 2020-01-09      10</span>
<span class="co">#&gt;  10:                    NA 2020-01-10      10</span>
<span class="co">#&gt;  11:                    NA 2020-01-11      10</span>
<span class="co">#&gt;  12:                    NA 2020-01-12      10</span>
<span class="co">#&gt;  13:                    NA 2020-01-13      10</span>
<span class="co">#&gt;  14:                    NA 2020-01-14      10</span>
<span class="co">#&gt;  15:                    NA 2020-01-15      10</span>
<span class="co">#&gt;  16:                    NA 2020-01-16      10</span>
<span class="co">#&gt;  17:                    NA 2020-01-17      10</span>
<span class="co">#&gt;  18:                    NA 2020-01-18      10</span>
<span class="co">#&gt;  19:                    NA 2020-01-19      10</span>
<span class="co">#&gt;  20:                    NA 2020-01-20      10</span>
<span class="co">#&gt;  21:                   301 2020-01-01       5</span>
<span class="co">#&gt;  22:                   301 2020-01-02       5</span>
<span class="co">#&gt;  23:                   301 2020-01-03       5</span>
<span class="co">#&gt;  24:                   301 2020-01-04       5</span>
<span class="co">#&gt;  25:                   301 2020-01-05       5</span>
<span class="co">#&gt;  26:                   301 2020-01-06       5</span>
<span class="co">#&gt;  27:                   301 2020-01-07       5</span>
<span class="co">#&gt;  28:                   301 2020-01-08       5</span>
<span class="co">#&gt;  29:                   301 2020-01-09       5</span>
<span class="co">#&gt;  30:                   301 2020-01-10       5</span>
<span class="co">#&gt;  31:                   301 2020-01-11       5</span>
<span class="co">#&gt;  32:                   301 2020-01-12       5</span>
<span class="co">#&gt;  33:                   301 2020-01-13       5</span>
<span class="co">#&gt;  34:                   301 2020-01-14       5</span>
<span class="co">#&gt;  35:                   301 2020-01-15       5</span>
<span class="co">#&gt;  36:                   301 2020-01-16       5</span>
<span class="co">#&gt;  37:                   301 2020-01-17       5</span>
<span class="co">#&gt;  38:                   301 2020-01-18       5</span>
<span class="co">#&gt;  39:                   301 2020-01-19       5</span>
<span class="co">#&gt;  40:                   301 2020-01-20       5</span>
<span class="co">#&gt;  41:                  1106 2020-01-01       5</span>
<span class="co">#&gt;  42:                  1106 2020-01-02       5</span>
<span class="co">#&gt;  43:                  1106 2020-01-03       5</span>
<span class="co">#&gt;  44:                  1106 2020-01-04       5</span>
<span class="co">#&gt;  45:                  1106 2020-01-05       5</span>
<span class="co">#&gt;  46:                  1106 2020-01-06       5</span>
<span class="co">#&gt;  47:                  1106 2020-01-07       5</span>
<span class="co">#&gt;  48:                  1106 2020-01-08       5</span>
<span class="co">#&gt;  49:                  1106 2020-01-09       5</span>
<span class="co">#&gt;  50:                  1106 2020-01-10       5</span>
<span class="co">#&gt;  51:                  1106 2020-01-11       5</span>
<span class="co">#&gt;  52:                  1106 2020-01-12       5</span>
<span class="co">#&gt;  53:                  1106 2020-01-13       5</span>
<span class="co">#&gt;  54:                  1106 2020-01-14       5</span>
<span class="co">#&gt;  55:                  1106 2020-01-15       5</span>
<span class="co">#&gt;  56:                  1106 2020-01-16       5</span>
<span class="co">#&gt;  57:                  1106 2020-01-17       5</span>
<span class="co">#&gt;  58:                  1106 2020-01-18       5</span>
<span class="co">#&gt;  59:                  1106 2020-01-19       5</span>
<span class="co">#&gt;  60:                  1106 2020-01-20       5</span>
<span class="co">#&gt;  61:                  2200 2020-01-01       5</span>
<span class="co">#&gt;  62:                  2200 2020-01-02       5</span>
<span class="co">#&gt;  63:                  2200 2020-01-03       5</span>
<span class="co">#&gt;  64:                  2200 2020-01-04       5</span>
<span class="co">#&gt;  65:                  2200 2020-01-05       5</span>
<span class="co">#&gt;  66:                  2200 2020-01-06       5</span>
<span class="co">#&gt;  67:                  2200 2020-01-07       5</span>
<span class="co">#&gt;  68:                  2200 2020-01-08       5</span>
<span class="co">#&gt;  69:                  2200 2020-01-09       5</span>
<span class="co">#&gt;  70:                  2200 2020-01-10       5</span>
<span class="co">#&gt;  71:                  2200 2020-01-11       5</span>
<span class="co">#&gt;  72:                  2200 2020-01-12       5</span>
<span class="co">#&gt;  73:                  2200 2020-01-13       5</span>
<span class="co">#&gt;  74:                  2200 2020-01-14       5</span>
<span class="co">#&gt;  75:                  2200 2020-01-15       5</span>
<span class="co">#&gt;  76:                  2200 2020-01-16       5</span>
<span class="co">#&gt;  77:                  2200 2020-01-17       5</span>
<span class="co">#&gt;  78:                  2200 2020-01-18       5</span>
<span class="co">#&gt;  79:                  2200 2020-01-19       5</span>
<span class="co">#&gt;  80:                  2200 2020-01-20       5</span>
<span class="co">#&gt;  81:                  5001 2020-01-01      10</span>
<span class="co">#&gt;  82:                  5001 2020-01-02      10</span>
<span class="co">#&gt;  83:                  5001 2020-01-03      10</span>
<span class="co">#&gt;  84:                  5001 2020-01-04      10</span>
<span class="co">#&gt;  85:                  5001 2020-01-05      10</span>
<span class="co">#&gt;  86:                  5001 2020-01-06      10</span>
<span class="co">#&gt;  87:                  5001 2020-01-07      10</span>
<span class="co">#&gt;  88:                  5001 2020-01-08      10</span>
<span class="co">#&gt;  89:                  5001 2020-01-09      10</span>
<span class="co">#&gt;  90:                  5001 2020-01-10      10</span>
<span class="co">#&gt;  91:                  5001 2020-01-11      10</span>
<span class="co">#&gt;  92:                  5001 2020-01-12      10</span>
<span class="co">#&gt;  93:                  5001 2020-01-13      10</span>
<span class="co">#&gt;  94:                  5001 2020-01-14      10</span>
<span class="co">#&gt;  95:                  5001 2020-01-15      10</span>
<span class="co">#&gt;  96:                  5001 2020-01-16      10</span>
<span class="co">#&gt;  97:                  5001 2020-01-17      10</span>
<span class="co">#&gt;  98:                  5001 2020-01-18      10</span>
<span class="co">#&gt;  99:                  5001 2020-01-19      10</span>
<span class="co">#&gt; 100:                  5001 2020-01-20      10</span>
<span class="co">#&gt;      location_msis_municip       date cases_n</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $day_county</span>
<span class="co">#&gt;      location_msis_county       date cases_n</span>
<span class="co">#&gt;   1:                   NA 2020-01-01       4</span>
<span class="co">#&gt;   2:                   NA 2020-01-02       4</span>
<span class="co">#&gt;   3:                   NA 2020-01-03       4</span>
<span class="co">#&gt;   4:                   NA 2020-01-04       4</span>
<span class="co">#&gt;   5:                   NA 2020-01-05       4</span>
<span class="co">#&gt;   6:                   NA 2020-01-06       4</span>
<span class="co">#&gt;   7:                   NA 2020-01-07       4</span>
<span class="co">#&gt;   8:                   NA 2020-01-08       4</span>
<span class="co">#&gt;   9:                   NA 2020-01-09       4</span>
<span class="co">#&gt;  10:                   NA 2020-01-10       4</span>
<span class="co">#&gt;  11:                   NA 2020-01-11       4</span>
<span class="co">#&gt;  12:                   NA 2020-01-12       4</span>
<span class="co">#&gt;  13:                   NA 2020-01-13       4</span>
<span class="co">#&gt;  14:                   NA 2020-01-14       4</span>
<span class="co">#&gt;  15:                   NA 2020-01-15       4</span>
<span class="co">#&gt;  16:                   NA 2020-01-16       4</span>
<span class="co">#&gt;  17:                   NA 2020-01-17       4</span>
<span class="co">#&gt;  18:                   NA 2020-01-18       4</span>
<span class="co">#&gt;  19:                   NA 2020-01-19       4</span>
<span class="co">#&gt;  20:                   NA 2020-01-20       4</span>
<span class="co">#&gt;  21:                    3 2020-01-01      11</span>
<span class="co">#&gt;  22:                    3 2020-01-02      11</span>
<span class="co">#&gt;  23:                    3 2020-01-03      11</span>
<span class="co">#&gt;  24:                    3 2020-01-04      11</span>
<span class="co">#&gt;  25:                    3 2020-01-05      11</span>
<span class="co">#&gt;  26:                    3 2020-01-06      11</span>
<span class="co">#&gt;  27:                    3 2020-01-07      11</span>
<span class="co">#&gt;  28:                    3 2020-01-08      11</span>
<span class="co">#&gt;  29:                    3 2020-01-09      11</span>
<span class="co">#&gt;  30:                    3 2020-01-10      11</span>
<span class="co">#&gt;  31:                    3 2020-01-11      11</span>
<span class="co">#&gt;  32:                    3 2020-01-12      11</span>
<span class="co">#&gt;  33:                    3 2020-01-13      11</span>
<span class="co">#&gt;  34:                    3 2020-01-14      11</span>
<span class="co">#&gt;  35:                    3 2020-01-15      11</span>
<span class="co">#&gt;  36:                    3 2020-01-16      11</span>
<span class="co">#&gt;  37:                    3 2020-01-17      11</span>
<span class="co">#&gt;  38:                    3 2020-01-18      11</span>
<span class="co">#&gt;  39:                    3 2020-01-19      11</span>
<span class="co">#&gt;  40:                    3 2020-01-20      11</span>
<span class="co">#&gt;  41:                   11 2020-01-01       5</span>
<span class="co">#&gt;  42:                   11 2020-01-02       5</span>
<span class="co">#&gt;  43:                   11 2020-01-03       5</span>
<span class="co">#&gt;  44:                   11 2020-01-04       5</span>
<span class="co">#&gt;  45:                   11 2020-01-05       5</span>
<span class="co">#&gt;  46:                   11 2020-01-06       5</span>
<span class="co">#&gt;  47:                   11 2020-01-07       5</span>
<span class="co">#&gt;  48:                   11 2020-01-08       5</span>
<span class="co">#&gt;  49:                   11 2020-01-09       5</span>
<span class="co">#&gt;  50:                   11 2020-01-10       5</span>
<span class="co">#&gt;  51:                   11 2020-01-11       5</span>
<span class="co">#&gt;  52:                   11 2020-01-12       5</span>
<span class="co">#&gt;  53:                   11 2020-01-13       5</span>
<span class="co">#&gt;  54:                   11 2020-01-14       5</span>
<span class="co">#&gt;  55:                   11 2020-01-15       5</span>
<span class="co">#&gt;  56:                   11 2020-01-16       5</span>
<span class="co">#&gt;  57:                   11 2020-01-17       5</span>
<span class="co">#&gt;  58:                   11 2020-01-18       5</span>
<span class="co">#&gt;  59:                   11 2020-01-19       5</span>
<span class="co">#&gt;  60:                   11 2020-01-20       5</span>
<span class="co">#&gt;  61:                   22 2020-01-01       5</span>
<span class="co">#&gt;  62:                   22 2020-01-02       5</span>
<span class="co">#&gt;  63:                   22 2020-01-03       5</span>
<span class="co">#&gt;  64:                   22 2020-01-04       5</span>
<span class="co">#&gt;  65:                   22 2020-01-05       5</span>
<span class="co">#&gt;  66:                   22 2020-01-06       5</span>
<span class="co">#&gt;  67:                   22 2020-01-07       5</span>
<span class="co">#&gt;  68:                   22 2020-01-08       5</span>
<span class="co">#&gt;  69:                   22 2020-01-09       5</span>
<span class="co">#&gt;  70:                   22 2020-01-10       5</span>
<span class="co">#&gt;  71:                   22 2020-01-11       5</span>
<span class="co">#&gt;  72:                   22 2020-01-12       5</span>
<span class="co">#&gt;  73:                   22 2020-01-13       5</span>
<span class="co">#&gt;  74:                   22 2020-01-14       5</span>
<span class="co">#&gt;  75:                   22 2020-01-15       5</span>
<span class="co">#&gt;  76:                   22 2020-01-16       5</span>
<span class="co">#&gt;  77:                   22 2020-01-17       5</span>
<span class="co">#&gt;  78:                   22 2020-01-18       5</span>
<span class="co">#&gt;  79:                   22 2020-01-19       5</span>
<span class="co">#&gt;  80:                   22 2020-01-20       5</span>
<span class="co">#&gt;  81:                   50 2020-01-01      10</span>
<span class="co">#&gt;  82:                   50 2020-01-02      10</span>
<span class="co">#&gt;  83:                   50 2020-01-03      10</span>
<span class="co">#&gt;  84:                   50 2020-01-04      10</span>
<span class="co">#&gt;  85:                   50 2020-01-05      10</span>
<span class="co">#&gt;  86:                   50 2020-01-06      10</span>
<span class="co">#&gt;  87:                   50 2020-01-07      10</span>
<span class="co">#&gt;  88:                   50 2020-01-08      10</span>
<span class="co">#&gt;  89:                   50 2020-01-09      10</span>
<span class="co">#&gt;  90:                   50 2020-01-10      10</span>
<span class="co">#&gt;  91:                   50 2020-01-11      10</span>
<span class="co">#&gt;  92:                   50 2020-01-12      10</span>
<span class="co">#&gt;  93:                   50 2020-01-13      10</span>
<span class="co">#&gt;  94:                   50 2020-01-14      10</span>
<span class="co">#&gt;  95:                   50 2020-01-15      10</span>
<span class="co">#&gt;  96:                   50 2020-01-16      10</span>
<span class="co">#&gt;  97:                   50 2020-01-17      10</span>
<span class="co">#&gt;  98:                   50 2020-01-18      10</span>
<span class="co">#&gt;  99:                   50 2020-01-19      10</span>
<span class="co">#&gt; 100:                   50 2020-01-20      10</span>
<span class="co">#&gt;      location_msis_county       date cases_n</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $day_nation</span>
<span class="co">#&gt;           date cases_n location_msis_nation</span>
<span class="co">#&gt;  1: 2020-01-01      35                    0</span>
<span class="co">#&gt;  2: 2020-01-02      35                    0</span>
<span class="co">#&gt;  3: 2020-01-03      35                    0</span>
<span class="co">#&gt;  4: 2020-01-04      35                    0</span>
<span class="co">#&gt;  5: 2020-01-05      35                    0</span>
<span class="co">#&gt;  6: 2020-01-06      35                    0</span>
<span class="co">#&gt;  7: 2020-01-07      35                    0</span>
<span class="co">#&gt;  8: 2020-01-08      35                    0</span>
<span class="co">#&gt;  9: 2020-01-09      35                    0</span>
<span class="co">#&gt; 10: 2020-01-10      35                    0</span>
<span class="co">#&gt; 11: 2020-01-11      35                    0</span>
<span class="co">#&gt; 12: 2020-01-12      35                    0</span>
<span class="co">#&gt; 13: 2020-01-13      35                    0</span>
<span class="co">#&gt; 14: 2020-01-14      35                    0</span>
<span class="co">#&gt; 15: 2020-01-15      35                    0</span>
<span class="co">#&gt; 16: 2020-01-16      35                    0</span>
<span class="co">#&gt; 17: 2020-01-17      35                    0</span>
<span class="co">#&gt; 18: 2020-01-18      35                    0</span>
<span class="co">#&gt; 19: 2020-01-19      35                    0</span>
<span class="co">#&gt; 20: 2020-01-20      35                    0</span>

<span class="co"># ---------------</span>
<span class="co"># this code occurs in the ordinary zone</span>

<span class="co"># the data is loaded in (probably from a .rds file)</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/copy.html">copy</a></span><span class="op">(</span><span class="va">d_agg</span><span class="op">)</span>

<span class="co"># 1. Create a variable (possibly a list) to hold the data</span>
<span class="va">d_agg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">d_agg</span><span class="op">$</span><span class="va">day_municip</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/copy.html">copy</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">day_municip</span><span class="op">)</span>
<span class="va">d_agg</span><span class="op">$</span><span class="va">day_county</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/copy.html">copy</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">day_county</span><span class="op">)</span>
<span class="va">d_agg</span><span class="op">$</span><span class="va">day_nation</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/copy.html">copy</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">day_nation</span><span class="op">)</span>

<span class="co"># 2. Clean the data</span>

<span class="co"># fixing location codes</span>
<span class="co"># 3. Replace NAs as appropriate for MSIS location numbers</span>
<span class="va">d_agg</span><span class="op">$</span><span class="va">day_municip</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">location_msis_municip</span><span class="op">)</span>, <span class="va">location_msis_municip</span> <span class="op">:=</span> <span class="fl">9999</span><span class="op">]</span>
<span class="va">d_agg</span><span class="op">$</span><span class="va">day_county</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">location_msis_county</span><span class="op">)</span>, <span class="va">location_msis_county</span> <span class="op">:=</span> <span class="fl">99</span><span class="op">]</span>

<span class="co"># 4. Convert MSIS location numbers to location_code's using `fhidata::norway_locations_msis_to_fhidata`</span>
<span class="co"># you may also do redistricting (kommunesammenslaaing) at this point (fhidata::norway_locations_redistricting())</span>
<span class="va">d_agg</span><span class="op">$</span><span class="va">day_municip</span><span class="op">[</span>, <span class="va">location_code</span> <span class="op">:=</span> <span class="fu">fhidata</span><span class="fu">::</span><span class="fu"><a href="../reference/norway_locations_msis_to_fhidata.html">norway_locations_msis_to_fhidata</a></span><span class="op">(</span><span class="va">location_msis_municip</span><span class="op">)</span><span class="op">]</span>
<span class="va">d_agg</span><span class="op">$</span><span class="va">day_county</span><span class="op">[</span>, <span class="va">location_code</span> <span class="op">:=</span> <span class="fu">fhidata</span><span class="fu">::</span><span class="fu"><a href="../reference/norway_locations_msis_to_fhidata.html">norway_locations_msis_to_fhidata</a></span><span class="op">(</span><span class="va">location_msis_county</span><span class="op">)</span><span class="op">]</span>
<span class="va">d_agg</span><span class="op">$</span><span class="va">day_nation</span><span class="op">[</span>, <span class="va">location_code</span> <span class="op">:=</span> <span class="fu">fhidata</span><span class="fu">::</span><span class="fu"><a href="../reference/norway_locations_msis_to_fhidata.html">norway_locations_msis_to_fhidata</a></span><span class="op">(</span><span class="va">location_msis_nation</span><span class="op">)</span><span class="op">]</span>

<span class="co"># redistricting</span>
<span class="kw">for</span><span class="op">(</span><span class="va">d_temp</span> <span class="kw">in</span> <span class="va">d_agg</span><span class="op">)</span><span class="op">{</span>
  <span class="va">d_temp</span><span class="op">[</span>, <span class="va">calyear</span> <span class="op">:=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span><span class="op">]</span>
  <span class="va">d_temp</span><span class="op">[</span>
    <span class="fu">fhidata</span><span class="fu">::</span><span class="fu"><a href="../reference/norway_locations_redistricting.html">norway_locations_redistricting</a></span><span class="op">(</span><span class="op">)</span>,
    on <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"location_code==location_code_original"</span>, <span class="st">"calyear"</span><span class="op">)</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"location_code_current"</span>, <span class="st">"weighting"</span><span class="op">)</span> <span class="op">:=</span> <span class="fu">.</span><span class="op">(</span><span class="va">location_code_current</span>, <span class="va">weighting</span><span class="op">)</span>
  <span class="op">]</span>
<span class="op">}</span>

<span class="co"># 5. Re-aggregate your data to different geographical levels to ensure that duplicates have now been removed</span>
<span class="co"># this will also fix the redistricting/kommunesammenslaaing issues</span>
<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">d_agg</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">d_agg</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">d_agg</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span>
    cases_n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">cases_n</span><span class="op">*</span><span class="va">weighting</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span>, keyby<span class="op">=</span><span class="fu">.</span><span class="op">(</span>
    location_code <span class="op">=</span> <span class="va">location_code_current</span>,
    <span class="va">date</span>
  <span class="op">)</span><span class="op">]</span>
<span class="op">}</span>

<span class="va">d_agg</span><span class="op">[</span><span class="op">]</span>
<span class="co">#&gt; $day_municip</span>
<span class="co">#&gt;               location_code       date cases_n</span>
<span class="co">#&gt;   1:                   &lt;NA&gt; 2020-01-01      NA</span>
<span class="co">#&gt;   2:                   &lt;NA&gt; 2020-01-02      NA</span>
<span class="co">#&gt;   3:                   &lt;NA&gt; 2020-01-03      NA</span>
<span class="co">#&gt;   4:                   &lt;NA&gt; 2020-01-04      NA</span>
<span class="co">#&gt;   5:                   &lt;NA&gt; 2020-01-05      NA</span>
<span class="co">#&gt;   6:                   &lt;NA&gt; 2020-01-06      NA</span>
<span class="co">#&gt;   7:                   &lt;NA&gt; 2020-01-07      NA</span>
<span class="co">#&gt;   8:                   &lt;NA&gt; 2020-01-08      NA</span>
<span class="co">#&gt;   9:                   &lt;NA&gt; 2020-01-09      NA</span>
<span class="co">#&gt;  10:                   &lt;NA&gt; 2020-01-10      NA</span>
<span class="co">#&gt;  11:                   &lt;NA&gt; 2020-01-11      NA</span>
<span class="co">#&gt;  12:                   &lt;NA&gt; 2020-01-12      NA</span>
<span class="co">#&gt;  13:                   &lt;NA&gt; 2020-01-13      NA</span>
<span class="co">#&gt;  14:                   &lt;NA&gt; 2020-01-14      NA</span>
<span class="co">#&gt;  15:                   &lt;NA&gt; 2020-01-15      NA</span>
<span class="co">#&gt;  16:                   &lt;NA&gt; 2020-01-16      NA</span>
<span class="co">#&gt;  17:                   &lt;NA&gt; 2020-01-17      NA</span>
<span class="co">#&gt;  18:                   &lt;NA&gt; 2020-01-18      NA</span>
<span class="co">#&gt;  19:                   &lt;NA&gt; 2020-01-19      NA</span>
<span class="co">#&gt;  20:                   &lt;NA&gt; 2020-01-20      NA</span>
<span class="co">#&gt;  21:            municip0301 2020-01-01       5</span>
<span class="co">#&gt;  22:            municip0301 2020-01-02       5</span>
<span class="co">#&gt;  23:            municip0301 2020-01-03       5</span>
<span class="co">#&gt;  24:            municip0301 2020-01-04       5</span>
<span class="co">#&gt;  25:            municip0301 2020-01-05       5</span>
<span class="co">#&gt;  26:            municip0301 2020-01-06       5</span>
<span class="co">#&gt;  27:            municip0301 2020-01-07       5</span>
<span class="co">#&gt;  28:            municip0301 2020-01-08       5</span>
<span class="co">#&gt;  29:            municip0301 2020-01-09       5</span>
<span class="co">#&gt;  30:            municip0301 2020-01-10       5</span>
<span class="co">#&gt;  31:            municip0301 2020-01-11       5</span>
<span class="co">#&gt;  32:            municip0301 2020-01-12       5</span>
<span class="co">#&gt;  33:            municip0301 2020-01-13       5</span>
<span class="co">#&gt;  34:            municip0301 2020-01-14       5</span>
<span class="co">#&gt;  35:            municip0301 2020-01-15       5</span>
<span class="co">#&gt;  36:            municip0301 2020-01-16       5</span>
<span class="co">#&gt;  37:            municip0301 2020-01-17       5</span>
<span class="co">#&gt;  38:            municip0301 2020-01-18       5</span>
<span class="co">#&gt;  39:            municip0301 2020-01-19       5</span>
<span class="co">#&gt;  40:            municip0301 2020-01-20       5</span>
<span class="co">#&gt;  41:            municip1106 2020-01-01       5</span>
<span class="co">#&gt;  42:            municip1106 2020-01-02       5</span>
<span class="co">#&gt;  43:            municip1106 2020-01-03       5</span>
<span class="co">#&gt;  44:            municip1106 2020-01-04       5</span>
<span class="co">#&gt;  45:            municip1106 2020-01-05       5</span>
<span class="co">#&gt;  46:            municip1106 2020-01-06       5</span>
<span class="co">#&gt;  47:            municip1106 2020-01-07       5</span>
<span class="co">#&gt;  48:            municip1106 2020-01-08       5</span>
<span class="co">#&gt;  49:            municip1106 2020-01-09       5</span>
<span class="co">#&gt;  50:            municip1106 2020-01-10       5</span>
<span class="co">#&gt;  51:            municip1106 2020-01-11       5</span>
<span class="co">#&gt;  52:            municip1106 2020-01-12       5</span>
<span class="co">#&gt;  53:            municip1106 2020-01-13       5</span>
<span class="co">#&gt;  54:            municip1106 2020-01-14       5</span>
<span class="co">#&gt;  55:            municip1106 2020-01-15       5</span>
<span class="co">#&gt;  56:            municip1106 2020-01-16       5</span>
<span class="co">#&gt;  57:            municip1106 2020-01-17       5</span>
<span class="co">#&gt;  58:            municip1106 2020-01-18       5</span>
<span class="co">#&gt;  59:            municip1106 2020-01-19       5</span>
<span class="co">#&gt;  60:            municip1106 2020-01-20       5</span>
<span class="co">#&gt;  61:            municip5001 2020-01-01      10</span>
<span class="co">#&gt;  62:            municip5001 2020-01-02      10</span>
<span class="co">#&gt;  63:            municip5001 2020-01-03      10</span>
<span class="co">#&gt;  64:            municip5001 2020-01-04      10</span>
<span class="co">#&gt;  65:            municip5001 2020-01-05      10</span>
<span class="co">#&gt;  66:            municip5001 2020-01-06      10</span>
<span class="co">#&gt;  67:            municip5001 2020-01-07      10</span>
<span class="co">#&gt;  68:            municip5001 2020-01-08      10</span>
<span class="co">#&gt;  69:            municip5001 2020-01-09      10</span>
<span class="co">#&gt;  70:            municip5001 2020-01-10      10</span>
<span class="co">#&gt;  71:            municip5001 2020-01-11      10</span>
<span class="co">#&gt;  72:            municip5001 2020-01-12      10</span>
<span class="co">#&gt;  73:            municip5001 2020-01-13      10</span>
<span class="co">#&gt;  74:            municip5001 2020-01-14      10</span>
<span class="co">#&gt;  75:            municip5001 2020-01-15      10</span>
<span class="co">#&gt;  76:            municip5001 2020-01-16      10</span>
<span class="co">#&gt;  77:            municip5001 2020-01-17      10</span>
<span class="co">#&gt;  78:            municip5001 2020-01-18      10</span>
<span class="co">#&gt;  79:            municip5001 2020-01-19      10</span>
<span class="co">#&gt;  80:            municip5001 2020-01-20      10</span>
<span class="co">#&gt;  81: notmainlandmunicip2200 2020-01-01       5</span>
<span class="co">#&gt;  82: notmainlandmunicip2200 2020-01-02       5</span>
<span class="co">#&gt;  83: notmainlandmunicip2200 2020-01-03       5</span>
<span class="co">#&gt;  84: notmainlandmunicip2200 2020-01-04       5</span>
<span class="co">#&gt;  85: notmainlandmunicip2200 2020-01-05       5</span>
<span class="co">#&gt;  86: notmainlandmunicip2200 2020-01-06       5</span>
<span class="co">#&gt;  87: notmainlandmunicip2200 2020-01-07       5</span>
<span class="co">#&gt;  88: notmainlandmunicip2200 2020-01-08       5</span>
<span class="co">#&gt;  89: notmainlandmunicip2200 2020-01-09       5</span>
<span class="co">#&gt;  90: notmainlandmunicip2200 2020-01-10       5</span>
<span class="co">#&gt;  91: notmainlandmunicip2200 2020-01-11       5</span>
<span class="co">#&gt;  92: notmainlandmunicip2200 2020-01-12       5</span>
<span class="co">#&gt;  93: notmainlandmunicip2200 2020-01-13       5</span>
<span class="co">#&gt;  94: notmainlandmunicip2200 2020-01-14       5</span>
<span class="co">#&gt;  95: notmainlandmunicip2200 2020-01-15       5</span>
<span class="co">#&gt;  96: notmainlandmunicip2200 2020-01-16       5</span>
<span class="co">#&gt;  97: notmainlandmunicip2200 2020-01-17       5</span>
<span class="co">#&gt;  98: notmainlandmunicip2200 2020-01-18       5</span>
<span class="co">#&gt;  99: notmainlandmunicip2200 2020-01-19       5</span>
<span class="co">#&gt; 100: notmainlandmunicip2200 2020-01-20       5</span>
<span class="co">#&gt;               location_code       date cases_n</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $day_county</span>
<span class="co">#&gt;            location_code       date cases_n</span>
<span class="co">#&gt;   1:            county03 2020-01-01      11</span>
<span class="co">#&gt;   2:            county03 2020-01-02      11</span>
<span class="co">#&gt;   3:            county03 2020-01-03      11</span>
<span class="co">#&gt;   4:            county03 2020-01-04      11</span>
<span class="co">#&gt;   5:            county03 2020-01-05      11</span>
<span class="co">#&gt;   6:            county03 2020-01-06      11</span>
<span class="co">#&gt;   7:            county03 2020-01-07      11</span>
<span class="co">#&gt;   8:            county03 2020-01-08      11</span>
<span class="co">#&gt;   9:            county03 2020-01-09      11</span>
<span class="co">#&gt;  10:            county03 2020-01-10      11</span>
<span class="co">#&gt;  11:            county03 2020-01-11      11</span>
<span class="co">#&gt;  12:            county03 2020-01-12      11</span>
<span class="co">#&gt;  13:            county03 2020-01-13      11</span>
<span class="co">#&gt;  14:            county03 2020-01-14      11</span>
<span class="co">#&gt;  15:            county03 2020-01-15      11</span>
<span class="co">#&gt;  16:            county03 2020-01-16      11</span>
<span class="co">#&gt;  17:            county03 2020-01-17      11</span>
<span class="co">#&gt;  18:            county03 2020-01-18      11</span>
<span class="co">#&gt;  19:            county03 2020-01-19      11</span>
<span class="co">#&gt;  20:            county03 2020-01-20      11</span>
<span class="co">#&gt;  21:            county11 2020-01-01       5</span>
<span class="co">#&gt;  22:            county11 2020-01-02       5</span>
<span class="co">#&gt;  23:            county11 2020-01-03       5</span>
<span class="co">#&gt;  24:            county11 2020-01-04       5</span>
<span class="co">#&gt;  25:            county11 2020-01-05       5</span>
<span class="co">#&gt;  26:            county11 2020-01-06       5</span>
<span class="co">#&gt;  27:            county11 2020-01-07       5</span>
<span class="co">#&gt;  28:            county11 2020-01-08       5</span>
<span class="co">#&gt;  29:            county11 2020-01-09       5</span>
<span class="co">#&gt;  30:            county11 2020-01-10       5</span>
<span class="co">#&gt;  31:            county11 2020-01-11       5</span>
<span class="co">#&gt;  32:            county11 2020-01-12       5</span>
<span class="co">#&gt;  33:            county11 2020-01-13       5</span>
<span class="co">#&gt;  34:            county11 2020-01-14       5</span>
<span class="co">#&gt;  35:            county11 2020-01-15       5</span>
<span class="co">#&gt;  36:            county11 2020-01-16       5</span>
<span class="co">#&gt;  37:            county11 2020-01-17       5</span>
<span class="co">#&gt;  38:            county11 2020-01-18       5</span>
<span class="co">#&gt;  39:            county11 2020-01-19       5</span>
<span class="co">#&gt;  40:            county11 2020-01-20       5</span>
<span class="co">#&gt;  41:            county50 2020-01-01      10</span>
<span class="co">#&gt;  42:            county50 2020-01-02      10</span>
<span class="co">#&gt;  43:            county50 2020-01-03      10</span>
<span class="co">#&gt;  44:            county50 2020-01-04      10</span>
<span class="co">#&gt;  45:            county50 2020-01-05      10</span>
<span class="co">#&gt;  46:            county50 2020-01-06      10</span>
<span class="co">#&gt;  47:            county50 2020-01-07      10</span>
<span class="co">#&gt;  48:            county50 2020-01-08      10</span>
<span class="co">#&gt;  49:            county50 2020-01-09      10</span>
<span class="co">#&gt;  50:            county50 2020-01-10      10</span>
<span class="co">#&gt;  51:            county50 2020-01-11      10</span>
<span class="co">#&gt;  52:            county50 2020-01-12      10</span>
<span class="co">#&gt;  53:            county50 2020-01-13      10</span>
<span class="co">#&gt;  54:            county50 2020-01-14      10</span>
<span class="co">#&gt;  55:            county50 2020-01-15      10</span>
<span class="co">#&gt;  56:            county50 2020-01-16      10</span>
<span class="co">#&gt;  57:            county50 2020-01-17      10</span>
<span class="co">#&gt;  58:            county50 2020-01-18      10</span>
<span class="co">#&gt;  59:            county50 2020-01-19      10</span>
<span class="co">#&gt;  60:            county50 2020-01-20      10</span>
<span class="co">#&gt;  61:     missingcounty99 2020-01-01       4</span>
<span class="co">#&gt;  62:     missingcounty99 2020-01-02       4</span>
<span class="co">#&gt;  63:     missingcounty99 2020-01-03       4</span>
<span class="co">#&gt;  64:     missingcounty99 2020-01-04       4</span>
<span class="co">#&gt;  65:     missingcounty99 2020-01-05       4</span>
<span class="co">#&gt;  66:     missingcounty99 2020-01-06       4</span>
<span class="co">#&gt;  67:     missingcounty99 2020-01-07       4</span>
<span class="co">#&gt;  68:     missingcounty99 2020-01-08       4</span>
<span class="co">#&gt;  69:     missingcounty99 2020-01-09       4</span>
<span class="co">#&gt;  70:     missingcounty99 2020-01-10       4</span>
<span class="co">#&gt;  71:     missingcounty99 2020-01-11       4</span>
<span class="co">#&gt;  72:     missingcounty99 2020-01-12       4</span>
<span class="co">#&gt;  73:     missingcounty99 2020-01-13       4</span>
<span class="co">#&gt;  74:     missingcounty99 2020-01-14       4</span>
<span class="co">#&gt;  75:     missingcounty99 2020-01-15       4</span>
<span class="co">#&gt;  76:     missingcounty99 2020-01-16       4</span>
<span class="co">#&gt;  77:     missingcounty99 2020-01-17       4</span>
<span class="co">#&gt;  78:     missingcounty99 2020-01-18       4</span>
<span class="co">#&gt;  79:     missingcounty99 2020-01-19       4</span>
<span class="co">#&gt;  80:     missingcounty99 2020-01-20       4</span>
<span class="co">#&gt;  81: notmainlandcounty22 2020-01-01       5</span>
<span class="co">#&gt;  82: notmainlandcounty22 2020-01-02       5</span>
<span class="co">#&gt;  83: notmainlandcounty22 2020-01-03       5</span>
<span class="co">#&gt;  84: notmainlandcounty22 2020-01-04       5</span>
<span class="co">#&gt;  85: notmainlandcounty22 2020-01-05       5</span>
<span class="co">#&gt;  86: notmainlandcounty22 2020-01-06       5</span>
<span class="co">#&gt;  87: notmainlandcounty22 2020-01-07       5</span>
<span class="co">#&gt;  88: notmainlandcounty22 2020-01-08       5</span>
<span class="co">#&gt;  89: notmainlandcounty22 2020-01-09       5</span>
<span class="co">#&gt;  90: notmainlandcounty22 2020-01-10       5</span>
<span class="co">#&gt;  91: notmainlandcounty22 2020-01-11       5</span>
<span class="co">#&gt;  92: notmainlandcounty22 2020-01-12       5</span>
<span class="co">#&gt;  93: notmainlandcounty22 2020-01-13       5</span>
<span class="co">#&gt;  94: notmainlandcounty22 2020-01-14       5</span>
<span class="co">#&gt;  95: notmainlandcounty22 2020-01-15       5</span>
<span class="co">#&gt;  96: notmainlandcounty22 2020-01-16       5</span>
<span class="co">#&gt;  97: notmainlandcounty22 2020-01-17       5</span>
<span class="co">#&gt;  98: notmainlandcounty22 2020-01-18       5</span>
<span class="co">#&gt;  99: notmainlandcounty22 2020-01-19       5</span>
<span class="co">#&gt; 100: notmainlandcounty22 2020-01-20       5</span>
<span class="co">#&gt;            location_code       date cases_n</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $day_nation</span>
<span class="co">#&gt;     location_code       date cases_n</span>
<span class="co">#&gt;  1:         norge 2020-01-01      35</span>
<span class="co">#&gt;  2:         norge 2020-01-02      35</span>
<span class="co">#&gt;  3:         norge 2020-01-03      35</span>
<span class="co">#&gt;  4:         norge 2020-01-04      35</span>
<span class="co">#&gt;  5:         norge 2020-01-05      35</span>
<span class="co">#&gt;  6:         norge 2020-01-06      35</span>
<span class="co">#&gt;  7:         norge 2020-01-07      35</span>
<span class="co">#&gt;  8:         norge 2020-01-08      35</span>
<span class="co">#&gt;  9:         norge 2020-01-09      35</span>
<span class="co">#&gt; 10:         norge 2020-01-10      35</span>
<span class="co">#&gt; 11:         norge 2020-01-11      35</span>
<span class="co">#&gt; 12:         norge 2020-01-12      35</span>
<span class="co">#&gt; 13:         norge 2020-01-13      35</span>
<span class="co">#&gt; 14:         norge 2020-01-14      35</span>
<span class="co">#&gt; 15:         norge 2020-01-15      35</span>
<span class="co">#&gt; 16:         norge 2020-01-16      35</span>
<span class="co">#&gt; 17:         norge 2020-01-17      35</span>
<span class="co">#&gt; 18:         norge 2020-01-18      35</span>
<span class="co">#&gt; 19:         norge 2020-01-19      35</span>
<span class="co">#&gt; 20:         norge 2020-01-20      35</span>

<span class="co"># 6. Pull out important dates</span>
<span class="va">date_min</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">d_agg</span><span class="op">$</span><span class="va">day_nation</span><span class="op">$</span><span class="va">date</span><span class="op">)</span>
<span class="va">date_max</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">d_agg</span><span class="op">$</span><span class="va">day_nation</span><span class="op">$</span><span class="va">date</span><span class="op">)</span>

<span class="co"># 7. Create `multiskeleton`</span>
<span class="co"># granularity_geo should have the following groups:</span>
<span class="co"># - nodata (when no data is available, and there is no 'finer' data available to aggregate up)</span>
<span class="co"># - all levels of granularity_geo where you have data available</span>
<span class="co"># If you do not have data for a specific granularity_geo, but there is 'finer' data available</span>
<span class="co"># then you should not include this granularity_geo in the multiskeleton, because you will create</span>
<span class="co"># it later when you aggregate up your data (baregion)</span>
<span class="va">multiskeleton_day</span> <span class="op">&lt;-</span> <span class="fu">fhidata</span><span class="fu">::</span><span class="fu"><a href="../reference/make_skeleton.html">make_skeleton</a></span><span class="op">(</span>
  date_min <span class="op">=</span> <span class="va">date_min</span>,
  date_max <span class="op">=</span> <span class="va">date_max</span>,
  granularity_geo <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    <span class="st">"nodata"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
      <span class="st">"wardoslo"</span>,
      <span class="st">"extrawardoslo"</span>,
      <span class="st">"missingwardoslo"</span>,
      <span class="st">"wardbergen"</span>,
      <span class="st">"missingwardbergen"</span>,
      <span class="st">"wardstavanger"</span>,
      <span class="st">"missingwardstavanger"</span>
    <span class="op">)</span>,
    
    <span class="st">"municip"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
      <span class="st">"municip"</span>,
      <span class="st">"notmainlandmunicip"</span>,
      <span class="st">"missingmunicip"</span>
    <span class="op">)</span>,
    
    <span class="st">"county"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
      <span class="st">"county"</span>,
      <span class="st">"notmainlandcounty"</span>, 
      <span class="st">"missingcounty"</span>
    <span class="op">)</span>,
    
    <span class="st">"nation"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
      <span class="st">"nation"</span>
    <span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span>

<span class="co"># 8. Merge in the information you have at different geographical granularities</span>
<span class="co"># one level at a time</span>
<span class="co"># municip</span>
<span class="va">multiskeleton_day</span><span class="op">$</span><span class="va">municip</span><span class="op">[</span>
  <span class="va">d_agg</span><span class="op">$</span><span class="va">day_municip</span>,
  on <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"location_code"</span>, <span class="st">"date"</span><span class="op">)</span>,
  <span class="va">cases_n</span> <span class="op">:=</span> <span class="va">cases_n</span>
<span class="op">]</span>
<span class="va">multiskeleton_day</span><span class="op">$</span><span class="va">municip</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">cases_n</span><span class="op">)</span>, <span class="va">cases_n</span> <span class="op">:=</span> <span class="fl">0</span><span class="op">]</span>

<span class="va">multiskeleton_day</span><span class="op">$</span><span class="va">municip</span><span class="op">[</span><span class="op">]</span>
<span class="co">#&gt;       granularity_time       date    granularity_geo          location_code</span>
<span class="co">#&gt;    1:              day 2020-01-01     missingmunicip     missingmunicip9999</span>
<span class="co">#&gt;    2:              day 2020-01-01            municip            municip0301</span>
<span class="co">#&gt;    3:              day 2020-01-01            municip            municip1101</span>
<span class="co">#&gt;    4:              day 2020-01-01            municip            municip1103</span>
<span class="co">#&gt;    5:              day 2020-01-01            municip            municip1106</span>
<span class="co">#&gt;   ---                                                                      </span>
<span class="co">#&gt; 7176:              day 2020-01-20            municip            municip5442</span>
<span class="co">#&gt; 7177:              day 2020-01-20            municip            municip5443</span>
<span class="co">#&gt; 7178:              day 2020-01-20            municip            municip5444</span>
<span class="co">#&gt; 7179:              day 2020-01-20 notmainlandmunicip notmainlandmunicip2100</span>
<span class="co">#&gt; 7180:              day 2020-01-20 notmainlandmunicip notmainlandmunicip2200</span>
<span class="co">#&gt;       cases_n</span>
<span class="co">#&gt;    1:       0</span>
<span class="co">#&gt;    2:       5</span>
<span class="co">#&gt;    3:       0</span>
<span class="co">#&gt;    4:       0</span>
<span class="co">#&gt;    5:       5</span>
<span class="co">#&gt;   ---        </span>
<span class="co">#&gt; 7176:       0</span>
<span class="co">#&gt; 7177:       0</span>
<span class="co">#&gt; 7178:       0</span>
<span class="co">#&gt; 7179:       0</span>
<span class="co">#&gt; 7180:       5</span>

<span class="co"># county</span>
<span class="va">multiskeleton_day</span><span class="op">$</span><span class="va">county</span><span class="op">[</span>
  <span class="va">d_agg</span><span class="op">$</span><span class="va">day_county</span>,
  on <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"location_code"</span>, <span class="st">"date"</span><span class="op">)</span>,
  <span class="va">cases_n</span> <span class="op">:=</span> <span class="va">cases_n</span>
<span class="op">]</span>
<span class="va">multiskeleton_day</span><span class="op">$</span><span class="va">county</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">cases_n</span><span class="op">)</span>, <span class="va">cases_n</span> <span class="op">:=</span> <span class="fl">0</span><span class="op">]</span>

<span class="va">multiskeleton_day</span><span class="op">$</span><span class="va">county</span><span class="op">[</span><span class="op">]</span>
<span class="co">#&gt;      granularity_time       date   granularity_geo       location_code cases_n</span>
<span class="co">#&gt;   1:              day 2020-01-01            county            county03      11</span>
<span class="co">#&gt;   2:              day 2020-01-01            county            county11       5</span>
<span class="co">#&gt;   3:              day 2020-01-01            county            county15       0</span>
<span class="co">#&gt;   4:              day 2020-01-01            county            county18       0</span>
<span class="co">#&gt;   5:              day 2020-01-01            county            county30       0</span>
<span class="co">#&gt;  ---                                                                          </span>
<span class="co">#&gt; 276:              day 2020-01-20            county            county50      10</span>
<span class="co">#&gt; 277:              day 2020-01-20            county            county54       0</span>
<span class="co">#&gt; 278:              day 2020-01-20     missingcounty     missingcounty99       4</span>
<span class="co">#&gt; 279:              day 2020-01-20 notmainlandcounty notmainlandcounty21       0</span>
<span class="co">#&gt; 280:              day 2020-01-20 notmainlandcounty notmainlandcounty22       5</span>

<span class="co"># nation</span>
<span class="va">multiskeleton_day</span><span class="op">$</span><span class="va">nation</span><span class="op">[</span>
  <span class="va">d_agg</span><span class="op">$</span><span class="va">day_nation</span>,
  on <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"location_code"</span>, <span class="st">"date"</span><span class="op">)</span>,
  <span class="va">cases_n</span> <span class="op">:=</span> <span class="va">cases_n</span>
<span class="op">]</span>
<span class="va">multiskeleton_day</span><span class="op">$</span><span class="va">nation</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">cases_n</span><span class="op">)</span>, <span class="va">cases_n</span> <span class="op">:=</span> <span class="fl">0</span><span class="op">]</span>

<span class="va">multiskeleton_day</span><span class="op">$</span><span class="va">nation</span><span class="op">[</span><span class="op">]</span>
<span class="co">#&gt;     granularity_time       date granularity_geo location_code cases_n</span>
<span class="co">#&gt;  1:              day 2020-01-01          nation         norge      35</span>
<span class="co">#&gt;  2:              day 2020-01-02          nation         norge      35</span>
<span class="co">#&gt;  3:              day 2020-01-03          nation         norge      35</span>
<span class="co">#&gt;  4:              day 2020-01-04          nation         norge      35</span>
<span class="co">#&gt;  5:              day 2020-01-05          nation         norge      35</span>
<span class="co">#&gt;  6:              day 2020-01-06          nation         norge      35</span>
<span class="co">#&gt;  7:              day 2020-01-07          nation         norge      35</span>
<span class="co">#&gt;  8:              day 2020-01-08          nation         norge      35</span>
<span class="co">#&gt;  9:              day 2020-01-09          nation         norge      35</span>
<span class="co">#&gt; 10:              day 2020-01-10          nation         norge      35</span>
<span class="co">#&gt; 11:              day 2020-01-11          nation         norge      35</span>
<span class="co">#&gt; 12:              day 2020-01-12          nation         norge      35</span>
<span class="co">#&gt; 13:              day 2020-01-13          nation         norge      35</span>
<span class="co">#&gt; 14:              day 2020-01-14          nation         norge      35</span>
<span class="co">#&gt; 15:              day 2020-01-15          nation         norge      35</span>
<span class="co">#&gt; 16:              day 2020-01-16          nation         norge      35</span>
<span class="co">#&gt; 17:              day 2020-01-17          nation         norge      35</span>
<span class="co">#&gt; 18:              day 2020-01-18          nation         norge      35</span>
<span class="co">#&gt; 19:              day 2020-01-19          nation         norge      35</span>
<span class="co">#&gt; 20:              day 2020-01-20          nation         norge      35</span>

<span class="co"># 9. Aggregate up to higher geographical granularities</span>
<span class="va">multiskeleton_day</span><span class="op">$</span><span class="va">baregion</span> <span class="op">&lt;-</span> <span class="va">multiskeleton_day</span><span class="op">$</span><span class="va">municip</span><span class="op">[</span>
  <span class="fu">fhidata</span><span class="fu">::</span><span class="fu"><a href="../reference/norway_locations_hierarchy.html">norway_locations_hierarchy</a></span><span class="op">(</span>
    from <span class="op">=</span> <span class="st">"municip"</span>,
    to <span class="op">=</span> <span class="st">"baregion"</span>
  <span class="op">)</span>,
  on <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
    <span class="st">"location_code==from_code"</span>
  <span class="op">)</span>
  <span class="op">]</span><span class="op">[</span>,
  <span class="fu">.</span><span class="op">(</span>
    cases_n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">cases_n</span><span class="op">)</span>,
    granularity_geo <span class="op">=</span> <span class="st">"baregion"</span>
  <span class="op">)</span>,
  by<span class="op">=</span><span class="fu">.</span><span class="op">(</span>
    <span class="va">granularity_time</span>, 
    <span class="va">date</span>,
    location_code <span class="op">=</span> <span class="va">to_code</span>
  <span class="op">)</span>
<span class="op">]</span>

<span class="va">multiskeleton_day</span><span class="op">$</span><span class="va">baregion</span><span class="op">[</span><span class="op">]</span>
<span class="co">#&gt;       granularity_time       date location_code cases_n granularity_geo</span>
<span class="co">#&gt;    1:              day 2020-01-01   baregion005       5        baregion</span>
<span class="co">#&gt;    2:              day 2020-01-02   baregion005       5        baregion</span>
<span class="co">#&gt;    3:              day 2020-01-03   baregion005       5        baregion</span>
<span class="co">#&gt;    4:              day 2020-01-04   baregion005       5        baregion</span>
<span class="co">#&gt;    5:              day 2020-01-05   baregion005       5        baregion</span>
<span class="co">#&gt;   ---                                                                  </span>
<span class="co">#&gt; 3176:              day 2020-01-16   baregion159       0        baregion</span>
<span class="co">#&gt; 3177:              day 2020-01-17   baregion159       0        baregion</span>
<span class="co">#&gt; 3178:              day 2020-01-18   baregion159       0        baregion</span>
<span class="co">#&gt; 3179:              day 2020-01-19   baregion159       0        baregion</span>
<span class="co">#&gt; 3180:              day 2020-01-20   baregion159       0        baregion</span>

<span class="co"># combine all the different granularity_geo's</span>
<span class="va">skeleton_day</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbindlist</a></span><span class="op">(</span><span class="va">multiskeleton_day</span>, fill <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">skeleton_day</span><span class="op">[</span><span class="op">]</span>
<span class="co">#&gt;        granularity_time       date      granularity_geo</span>
<span class="co">#&gt;     1:              day 2020-01-01        extrawardoslo</span>
<span class="co">#&gt;     2:              day 2020-01-01        extrawardoslo</span>
<span class="co">#&gt;     3:              day 2020-01-01    missingwardbergen</span>
<span class="co">#&gt;     4:              day 2020-01-01      missingwardoslo</span>
<span class="co">#&gt;     5:              day 2020-01-01 missingwardstavanger</span>
<span class="co">#&gt;    ---                                                 </span>
<span class="co">#&gt; 11396:              day 2020-01-16             baregion</span>
<span class="co">#&gt; 11397:              day 2020-01-17             baregion</span>
<span class="co">#&gt; 11398:              day 2020-01-18             baregion</span>
<span class="co">#&gt; 11399:              day 2020-01-19             baregion</span>
<span class="co">#&gt; 11400:              day 2020-01-20             baregion</span>
<span class="co">#&gt;                     location_code cases_n</span>
<span class="co">#&gt;     1:        extrawardoslo030116      NA</span>
<span class="co">#&gt;     2:        extrawardoslo030117      NA</span>
<span class="co">#&gt;     3:    missingwardbergen460199      NA</span>
<span class="co">#&gt;     4:      missingwardoslo030199      NA</span>
<span class="co">#&gt;     5: missingwardstavanger110399      NA</span>
<span class="co">#&gt;    ---                                   </span>
<span class="co">#&gt; 11396:                baregion159       0</span>
<span class="co">#&gt; 11397:                baregion159       0</span>
<span class="co">#&gt; 11398:                baregion159       0</span>
<span class="co">#&gt; 11399:                baregion159       0</span>
<span class="co">#&gt; 11400:                baregion159       0</span>

<span class="co"># 10. (If desirable) aggregate up to higher time granularities</span>
<span class="co"># if necessary, it is now easy to aggregate up to weekly data from here</span>
<span class="va">skeleton_week</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/copy.html">copy</a></span><span class="op">(</span><span class="va">skeleton_day</span><span class="op">)</span>
<span class="co"># it is better to use fhi::isoyearweek_c function</span>
<span class="co"># but we cannot not use this function inside a 'fhidata' vignette due to circular dependency issues</span>
<span class="va">skeleton_week</span><span class="op">[</span>, <span class="va">isoyearweek</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/year.html">isoyear</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>,<span class="st">"-"</span>, <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/week.html">isoweek</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>
<span class="va">skeleton_week</span> <span class="op">&lt;-</span> <span class="va">skeleton_week</span><span class="op">[</span>
  ,
  <span class="fu">.</span><span class="op">(</span>
    cases_n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">cases_n</span><span class="op">)</span>,
    granularity_time <span class="op">=</span> <span class="st">"week"</span>
  <span class="op">)</span>,
  keyby <span class="op">=</span> <span class="fu">.</span><span class="op">(</span>
    <span class="va">isoyearweek</span>,
    <span class="va">granularity_geo</span>,
    <span class="va">location_code</span>
  <span class="op">)</span>
<span class="op">]</span>

<span class="va">skeleton_week</span><span class="op">[</span><span class="op">]</span>
<span class="co">#&gt;       isoyearweek granularity_geo       location_code cases_n granularity_time</span>
<span class="co">#&gt;    1:      2020-1        baregion         baregion001       0             week</span>
<span class="co">#&gt;    2:      2020-1        baregion         baregion002       0             week</span>
<span class="co">#&gt;    3:      2020-1        baregion         baregion003       0             week</span>
<span class="co">#&gt;    4:      2020-1        baregion         baregion004       0             week</span>
<span class="co">#&gt;    5:      2020-1        baregion         baregion005      25             week</span>
<span class="co">#&gt;   ---                                                                         </span>
<span class="co">#&gt; 2276:      2020-4   wardstavanger wardstavanger110305      NA             week</span>
<span class="co">#&gt; 2277:      2020-4   wardstavanger wardstavanger110306      NA             week</span>
<span class="co">#&gt; 2278:      2020-4   wardstavanger wardstavanger110307      NA             week</span>
<span class="co">#&gt; 2279:      2020-4   wardstavanger wardstavanger110308      NA             week</span>
<span class="co">#&gt; 2280:      2020-4   wardstavanger wardstavanger110309      NA             week</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Richard Aubrey White, Chi Zhang.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
